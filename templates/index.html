{% extends "base.html" %}

{% block title %}YouTube Audio Downloader{% endblock %}

{% block content %}
<div class="container">
    <div class="header-section">
        <h2>
            <i class="fab fa-youtube text-red"></i>
            YouTube Audio Downloader
        </h2>
        <p class="subtitle">
            Download simplificado de canais completos OU vídeos individuais do YouTube para GCP bucket
        </p>
    </div>



    <!-- Formulário Principal -->
    <div class="form-section">
        <form id="processForm" class="process-form">
            <!-- Channel URL Input -->
            <div class="form-group">
                <label for="channelUrl">
                    <i class="fas fa-tv"></i>
                    URL do Canal (Opcional)
                </label>
                <input 
                    type="text" 
                    id="channelUrl" 
                    name="channelUrl" 
                    placeholder="https://www.youtube.com/@canal..." 
                    class="form-input"
                >
                <small class="form-help">Cole a URL do canal para processar todos os vídeos automaticamente</small>
            </div>
            
            <!-- URL Input -->
            <div class="form-group">
                <label for="url">
                    <i class="fas fa-link"></i>
                    URL do Vídeo (Opcional)
                </label>
                <input 
                    type="url" 
                    id="url" 
                    name="url" 
                    placeholder="https://www.youtube.com/watch?v=..." 
                    class="form-input"
                >
                <small class="form-help">Para processar apenas um vídeo específico</small>
            </div>
            
            <!-- Info Box -->
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <p><strong>Escolha uma opção:</strong> Insira a URL do canal para processar todos os vídeos OU a URL de um vídeo específico para processamento individual.</p>
            </div>

            <!-- Configurações Avançadas -->
            <div class="advanced-options">
                <button type="button" class="toggle-advanced" onclick="toggleAdvanced()">
                    <i class="fas fa-cog"></i>
                    Configurações Avançadas
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </button>
                
                <div id="advancedOptions" class="advanced-content hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filename">
                                <i class="fas fa-file-audio"></i>
                                Nome do Arquivo
                            </label>
                            <input 
                                type="text" 
                                id="filename" 
                                name="filename" 
                                placeholder="nome_personalizado"
                                class="form-input"
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="session_name">
                                <i class="fas fa-folder"></i>
                                Nome da Sessão
                            </label>
                            <input 
                                type="text" 
                                id="session_name" 
                                name="session_name" 
                                placeholder="minha_sessao"
                                class="form-input"
                            >
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="max_videos">
                                <i class="fas fa-list"></i>
                                Máximo de Vídeos (canal)
                            </label>
                            <input 
                                type="number" 
                                id="max_videos" 
                                name="max_videos" 
                                min="1" 
                                max="10000"
                                value="2500"
                                placeholder="2500"
                                class="form-input"
                            >
                            <small class="form-help">Limite de vídeos para processar em canais</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botão de Processar -->
            <button type="submit" class="btn-process" id="processBtn">
                <i class="fas fa-download"></i>
                Baixar Áudios
            </button>
        </form>
    </div>

    <!-- Progress Section -->
    <div id="progressSection" class="progress-section hidden">
        <div class="progress-container">
            <h3 id="progressTitle">Processando...</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <p id="progressMessage" class="progress-message">Iniciando...</p>
            <div class="progress-details">
                <span id="progressPercent">0%</span>
                <span id="progressTime"></span>
            </div>
        </div>
        
        <div class="progress-steps">
            <div class="step" data-step="waiting">
                <i class="fas fa-hourglass-start"></i>
                <span>Aguardando</span>
            </div>
            <div class="step" data-step="downloading">
                <i class="fas fa-download"></i>
                <span>Download</span>
            </div>
            <div class="step" data-step="finalizing">
                <i class="fas fa-folder"></i>
                <span>Organizando</span>
            </div>
            <div class="step" data-step="uploading">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Upload GCP</span>
            </div>
            <div class="step" data-step="completed">
                <i class="fas fa-check"></i>
                <span>Concluído</span>
            </div>
        </div>
    </div>

    <!-- Error Section -->
    <div id="errorSection" class="error-section hidden">
        <div class="error-container">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Erro no Processamento</h3>
            <p id="errorMessage"></p>
            <button onclick="resetForm()" class="btn-secondary">
                <i class="fas fa-redo"></i>
                Tentar Novamente
            </button>
        </div>
    </div>

     <!-- Features Section -->
     <div class="features-section">
         <h3>Recursos do Downloader</h3>
         <div class="features-grid">
             <div class="feature-card">
                 <i class="fab fa-youtube"></i>
                 <h4>Download Direto</h4>
                 <p>Baixa áudio em FLAC com máxima qualidade diretamente do YouTube</p>
                 <div class="feature-tools">
                     <span class="tool-tag">YT-DLP</span>
                     <span class="tool-tag">FLAC</span>
                     <span class="tool-tag">24KHZ</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-tv"></i>
                 <h4>Escaneamento de Canais</h4>
                 <p>Escaneia canais completos e baixa todos os vídeos automaticamente</p>
                 <div class="feature-tools">
                     <span class="tool-tag">YOUTUBE API</span>
                     <span class="tool-tag">CHANNEL SCAN</span>
                     <span class="tool-tag">BULK DOWNLOAD</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-file-code"></i>
                 <h4>Metadata JSON</h4>
                 <p>Gera arquivos JSON com informações detalhadas de cada vídeo</p>
                 <div class="feature-tools">
                     <span class="tool-tag">JSON</span>
                     <span class="tool-tag">METADATA</span>
                     <span class="tool-tag">VIDEO INFO</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-list"></i>
                 <h4>Lista de URLs</h4>
                 <p>Cria arquivo .txt com todas as URLs processadas e status</p>
                 <div class="feature-tools">
                     <span class="tool-tag">TXT FILE</span>
                     <span class="tool-tag">URL LIST</span>
                     <span class="tool-tag">STATUS</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-folder-open"></i>
                 <h4>Organização por Sessão</h4>
                 <p>Organiza downloads em sessões com estrutura de pastas clara</p>
                 <div class="feature-tools">
                     <span class="tool-tag">SESSION</span>
                     <span class="tool-tag">ORGANIZED</span>
                     <span class="tool-tag">STRUCTURE</span>
                 </div>
             </div>
             <div class="feature-card">
                 <i class="fas fa-cloud-upload-alt"></i>
                 <h4>Pronto para GCP</h4>
                 <p>Arquivos organizados e prontos para upload no Google Cloud Storage</p>
                 <div class="feature-tools">
                     <span class="tool-tag">GCP READY</span>
                     <span class="tool-tag">BUCKET</span>
                     <span class="tool-tag">CLOUD STORAGE</span>
                 </div>
             </div>
         </div>
     </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentJobId = null;
let progressInterval = null;

function toggleAdvanced() {
    const options = document.getElementById('advancedOptions');
    const icon = document.querySelector('.toggle-icon');
    
    if (options.classList.contains('hidden')) {
        options.classList.remove('hidden');
        icon.classList.add('rotated');
    } else {
        options.classList.add('hidden');
        icon.classList.remove('rotated');
    }
}

function showProgress() {
    document.getElementById('progressSection').classList.remove('hidden');
    document.getElementById('errorSection').classList.add('hidden');
    document.querySelector('.form-section').style.opacity = '0.7';
    document.getElementById('processBtn').disabled = true;
}

function hideProgress() {
    document.getElementById('progressSection').classList.add('hidden');
    document.querySelector('.form-section').style.opacity = '1';
    document.getElementById('processBtn').disabled = false;
}

function showError(message) {
    document.getElementById('errorSection').classList.remove('hidden');
    document.getElementById('errorMessage').textContent = message;
    hideProgress();
}

function resetForm() {
    document.getElementById('errorSection').classList.add('hidden');
    document.getElementById('progressSection').classList.add('hidden');
    document.querySelector('.form-section').style.opacity = '1';
    document.getElementById('processBtn').disabled = false;
    
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
    
    // Reset progress
    updateProgress('waiting', 0, 'Pronto para processar');
}

function updateProgress(status, progress, message) {
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressMessage').textContent = message;
    document.getElementById('progressPercent').textContent = progress + '%';
    
    // Update steps
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
    });
    
    const currentStep = document.querySelector(`[data-step="${status}"]`);
    if (currentStep) {
        currentStep.classList.add('active');
        
        // Add success animation for completed steps
        if (progress > 0 && status !== 'waiting') {
            setTimeout(() => {
                const icon = currentStep.querySelector('i');
                if (icon && !icon.classList.contains('fa-check-circle')) {
                    icon.className = 'fas fa-check-circle';
                    currentStep.classList.add('success-pulse');
                }
            }, 500);
        }
    }
    
    // Mark previous steps as completed with green checkmarks
    const steps = ['waiting', 'downloading', 'finalizing', 'uploading', 'completed'];
    const currentIndex = steps.indexOf(status);
    
    for (let i = 0; i < currentIndex; i++) {
        const step = document.querySelector(`[data-step="${steps[i]}"]`);
        if (step) {
            step.classList.add('completed');
            step.classList.remove('active');
            
            // Add green checkmark for completed steps
            const icon = step.querySelector('i');
            if (icon) {
                icon.className = 'fas fa-check-circle';
            }
        }
    }
}

function pollJobStatus(jobId) {
    axios.get(`/status/${jobId}`)
        .then(response => {
            const data = response.data;
            updateProgress(data.status, data.progress, data.message);
            
            if (data.status === 'completed') {
                clearInterval(progressInterval);
                setTimeout(() => {
                    window.location.href = `/results/${jobId}`;
                }, 1500);
            } else if (data.status === 'failed') {
                clearInterval(progressInterval);
                showError(data.error || 'Erro desconhecido no processamento');
            }
        })
        .catch(error => {
            console.error('Erro ao verificar status:', error);
            clearInterval(progressInterval);
            showError('Erro de comunicação com o servidor');
        });
}

document.getElementById('processForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
        // Get form data
        for (let [key, value] of formData.entries()) {
            if (value.trim() !== '') {
                // Convert numeric fields
                if (['max_videos'].includes(key)) {
                    data[key] = parseInt(value);
                } else {
                    data[key] = value;
                }
            }
        }
    
    // Validate URLs
    const channelUrl = data.channelUrl;
    const videoUrl = data.url;
    
    // Check if at least one URL is provided
    if ((!channelUrl || channelUrl.trim() === '') && (!videoUrl || videoUrl.trim() === '')) {
        showError('Por favor, insira uma URL do canal OU uma URL de vídeo para processar');
        return;
    }
    
    // Validate channel URL if provided
    if (channelUrl && channelUrl.trim() !== '') {
        if (!isValidYouTubeUrl(channelUrl)) {
            showError('Por favor, insira uma URL válida do canal YouTube (ex: https://www.youtube.com/@canal)');
            return;
        }
    }
    
    // Validate video URL if provided
    if (videoUrl && videoUrl.trim() !== '') {
        if (!isValidYouTubeUrl(videoUrl)) {
            showError('Por favor, insira uma URL válida do vídeo YouTube (ex: https://www.youtube.com/watch?v=...)');
            return;
        }
    }
    
    // Check if both URLs are provided (not recommended)
    if (channelUrl && channelUrl.trim() !== '' && videoUrl && videoUrl.trim() !== '') {
        showError('Por favor, insira apenas uma URL: canal OU vídeo, não ambos');
        return;
    }
    
    showProgress();
    updateProgress('waiting', 0, 'Enviando solicitação...');
    
    // Determine processing type based on input
    let endpoint = '/process';
    let progressMessage = 'Processamento iniciado...';
    
    if (channelUrl && channelUrl.trim() !== '') {
        // Process entire channel
        endpoint = '/process_channel';
        progressMessage = 'Iniciando processamento do canal...';
    } else if (videoUrl && videoUrl.trim() !== '') {
        // Process single video
        endpoint = '/process';
        progressMessage = 'Iniciando processamento do vídeo...';
    }
    
    axios.post(endpoint, data)
        .then(response => {
            currentJobId = response.data.job_id;
            updateProgress('waiting', 5, progressMessage);
            
            // Start polling for status updates
            progressInterval = setInterval(() => {
                pollJobStatus(currentJobId);
            }, 2000);
        })
        .catch(error => {
            const message = error.response?.data?.error || 'Erro ao iniciar processamento';
            showError(message);
        });
});

function isValidYouTubeUrl(url) {
    const patterns = [
        /^https:\/\/www\.youtube\.com\/@[a-zA-Z0-9_-]+$/,
        /^https:\/\/www\.youtube\.com\/channel\/[a-zA-Z0-9_-]+$/,
        /^https:\/\/www\.youtube\.com\/c\/[a-zA-Z0-9_-]+$/,
        /^https:\/\/www\.youtube\.com\/user\/[a-zA-Z0-9_-]+$/,
        /^https:\/\/www\.youtube\.com\/watch\?v=[a-zA-Z0-9_-]+$/,
        /^https:\/\/youtu\.be\/[a-zA-Z0-9_-]+$/
    ];
    
    return patterns.some(pattern => pattern.test(url));
}
</script>
{% endblock %}
